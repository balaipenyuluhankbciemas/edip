<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDIP | Buat Dokumentasi</title>
    
    <!-- Shortcut Icon -->
    <link rel="shortcut icon" href="https://newsiga-siga.bkkbn.go.id/icon_bkkbn.png">

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Cropper.js for image cropping -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

    <!-- Import iziToast untuk notifikasi -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/css/iziToast.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/js/iziToast.min.js"></script>

    <style>
        /* Custom styles for a better look and feel */
        body {
            font-family: 'Inter', sans-serif;
            padding-top: 80px; /* Add padding to the top to prevent header overlap */
            padding-bottom: 80px; /* Add padding to the bottom to prevent footer overlap */
        }
        .preview-container {
            width: 100%;
            height: 200px; /* Adjusted height for smaller grid */
            background-color: #f0f4f8;
            border: 2px dashed #cbd5e1;
            overflow: hidden;
            border-radius: 0.5rem;
        }
        /* This rule is important for cropper.js to display correctly */
        .preview-container img {
            max-width: 100%;
            max-height: 100%;
        }
        .upload-label {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            background-color: #4f46e5;
            color: white;
            transition: background-color 0.3s;
        }
        .upload-label:hover {
            background-color: #4338ca;
        }
        .btn-action {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            color: white;
            transition: background-color 0.3s, transform 0.2s;
        }
        .btn-action:hover {
            transform: scale(1.05);
        }
        .btn-action:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        .btn-generate {
            background-color: #16a34a;
        }
        .btn-generate:hover {
            background-color: #15803d;
        }
        .btn-confirm {
            background-color: #2563eb;
        }
        .btn-confirm:hover {
             background-color: #1d4ed8;
        }
        .btn-cancel {
            background-color: #6b7280;
        }
        .btn-cancel:hover {
            background-color: #4b5563;
        }

        /* Animation Keyframes */
        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        /* Animation Classes */
        .animate-slide-down {
            animation: slideDown 0.7s ease-out forwards;
        }

        .animate-slide-up {
            animation: slideUp 0.7s ease-out forwards;
        }

        /* Styles for the crop lock toggle */
        #cropLockToggle:checked ~ .dot {
            transform: translateX(100%);
        }
        #cropLockToggle:checked ~ .block {
            background-color: #a5b4fc;
        }
        #cropLockToggle:checked ~ .dot {
            background-color: #4f46e5;
        }

        /* Styles to lock cropper resizing */
        #imageGridContainer.crop-locked .cropper-handle,
        #imageGridContainer.crop-locked .cropper-point {
            display: none !important;
        }
        
        #imageGridContainer.crop-locked .cropper-line {
            pointer-events: none !important;
        }
        
        #imageGridContainer.crop-locked .cropper-face {
            cursor: move !important;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col min-h-screen">

    <!-- Header -->
    <header id="pageHeader" class="bg-white shadow-md w-full fixed top-0 left-0 right-0 z-50" style="transform: translateY(-100%);">
        <div class="container mx-auto p-4 flex justify-between items-center">
            <a href="https://balaipenyuluhankbciemas.github.io/edip/" title="Kembali ke Menu" class="flex items-center gap-2 text-gray-700 hover:text-indigo-600 transition-colors w-fit">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                <span class="font-semibold">Kembali ke Menu</span>
            </a>
            <div id="userInfoContainer" class="hidden items-center gap-2 md:gap-4">
                 <button id="historyBtn" class="btn-action bg-blue-600 hover:bg-blue-700 px-3 py-2 text-sm">Riwayat</button>
                 <button id="logoutBtn" class="btn-action bg-red-600 hover:bg-red-700 px-3 py-2 text-sm">Logout</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
            <div class="bg-white p-8 rounded-2xl shadow-lg">
                
                <!-- Page Title -->
                <div class="text-center mb-6">
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">DOKUMENTASI KEGIATAN</h1>
                    <p class="text-gray-600 mt-2">Unggah minimal 1 hingga 6 gambar, sesuaikan ukurannya, dan cetak sebagai PDF.</p>
                </div>

                <!-- Nama Kegiatan Input -->
                <div class="mb-8 max-w-xl mx-auto">
                    <label for="namaKegiatan" class="block text-sm font-medium text-gray-700 mb-2">NAMA KEGIATAN</label>
                    <input type="text" id="namaKegiatan" name="namaKegiatan" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm transition-colors duration-300 focus:ring-2 uppercase" placeholder="CONTOH: POSYANDU/PENYULUHAN/MBG" oninput="this.value = this.value.toUpperCase()">
                </div>

                <!-- Image Upload and Crop Section -->
                <div id="imageGridContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Image Upload Slots (Generated by JS) -->
                </div>

                <!-- Action Controls -->
                <div class="mt-10 flex flex-col items-center gap-4">
                     <!-- Crop Lock Toggle -->
                    <div class="flex items-center justify-center">
                        <label for="cropLockToggle" class="flex items-center cursor-pointer">
                            <div class="relative">
                                <input type="checkbox" id="cropLockToggle" class="sr-only" checked>
                                <div class="block bg-gray-200 w-14 h-8 rounded-full"></div>
                                <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition-transform duration-300 ease-in-out"></div>
                            </div>
                            <div class="ml-3 text-gray-700 font-medium">
                                Kunci Ukuran Crop (Hanya Geser)
                            </div>
                        </label>
                    </div>

                    <p id="infoText" class="text-sm text-gray-500">Silakan unggah minimal 1 gambar untuk membuat PDF.</p>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer id="pageFooter" class="fixed bottom-0 left-0 right-0 bg-gray-800 text-white z-50" style="transform: translateY(100%);">
        <div class="container mx-auto px-6 py-4 text-center">
            <p>&copy; 2025 Smysnie - Edip.</p>
        </div>
    </footer>

    <!-- FAB for PDF Generation -->
    <button id="previewBtn" title="Buat PDF" class="fixed bottom-8 right-8 bg-green-600 hover:bg-green-700 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center transition-transform duration-300 ease-in-out hover:scale-110 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none z-[60]" disabled>
        <!-- PDF Icon -->
        <svg id="previewBtnIcon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <!-- Loader -->
        <svg id="previewBtnLoader" class="animate-spin h-8 w-8 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </button>


    <!-- Wilayah Selection Modal -->
    <div id="wilayahModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-[100] flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md space-y-6">
            <h2 class="text-2xl font-bold text-center text-gray-900">Pilih Wilayah Kerja</h2>
            <div class="space-y-4">
                <div>
                    <label for="namaLengkap" class="block text-sm font-medium text-gray-700">NAMA LENGKAP</label>
                    <input type="text" id="namaLengkap" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 uppercase transition-colors duration-300" oninput="this.value = this.value.toUpperCase()">
                </div>
                <div>
                    <label for="provinsi" class="block text-sm font-medium text-gray-700">PROVINSI</label>
                    <select id="provinsi" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md bg-gray-100" disabled>
                        <option selected>JAWA BARAT</option>
                    </select>
                </div>
                <div>
                    <label for="kabupaten" class="block text-sm font-medium text-gray-700">KAB/KOTA</label>
                    <select id="kabupaten" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md bg-gray-100" disabled>
                        <option selected>SUKABUMI</option>
                    </select>
                </div>
                <div>
                    <label for="kecamatan" class="block text-sm font-medium text-gray-700">KECAMATAN</label>
                    <select id="kecamatan" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md bg-gray-100" disabled>
                        <option selected>CIEMAS</option>
                    </select>
                </div>
                <div>
                    <label for="desa" class="block text-sm font-medium text-gray-700">DESA/KELURAHAN</label>
                    <select id="desa" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-2 sm:text-sm rounded-md transition-colors duration-300">
                        <option value="" disabled selected>-- Pilih Desa --</option>
                        <option value="CIEMAS">CIEMAS</option>
                        <option value="CIBENDA">CIBENDA</option>
                        <option value="CIWARU">CIWARU</option>
                        <option value="MEKARJAYA">MEKARJAYA</option>
                        <option value="GIRIMUKTI">GIRIMUKTI</option>
                        <option value="TAMANJAYA">TAMANJAYA</option>
                        <option value="MANDRAJAYA">MANDRAJAYA</option>
                        <option value="SIDAMULYA">SIDAMULYA</option>
                        <option value="MEKARSAKTI">MEKARSAKTI</option>
                    </select>
                </div>
            </div>
            <button id="simpanWilayahBtn" class="w-full btn-action btn-confirm flex items-center justify-center">
                <span id="simpanBtnText">Simpan & Lanjutkan</span>
                <svg id="simpanBtnLoader" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-[100] flex items-center justify-center p-4">
        <div class="relative bg-white p-8 rounded-2xl shadow-2xl w-full max-w-3xl space-y-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <h2 class="text-2xl font-bold text-gray-900">Riwayat Pembuatan PDF</h2>
                    <button id="deleteSelectedBtn" class="hidden btn-action bg-red-600 hover:bg-red-700 px-3 py-2 text-sm">Hapus Terpilih</button>
                </div>
                <button id="closeHistoryBtn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="overflow-x-auto max-h-96">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="p-4">
                                <input type="checkbox" id="selectAllCheckbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Kegiatan</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Dibuat</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- History data will be inserted here -->
                    </tbody>
                </table>
            </div>
            <div id="historyLoaderContainer" class="text-center">
                <button id="loadMoreBtn" class="w-full btn-action bg-gray-600 hover:bg-gray-700 flex items-center justify-center">
                    <span id="loadMoreText">Lihat Data Selanjutnya</span>
                    <svg id="loadMoreLoader" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
            <!-- History Action Loader -->
            <div id="historyActionLoader" class="hidden absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center rounded-2xl">
                <svg class="animate-spin h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        </div>
    </div>


    <!-- Modal for Preview and Loader -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
        <div id="modalContent" class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl w-full max-w-3xl">
            <!-- Preview Section -->
            <div id="previewSection">
                <h3 class="text-2xl font-bold mb-6 text-center text-gray-800">Pratinjau PDF</h3>
                <div id="previewImageContainer" class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                    <!-- Preview images will be inserted here -->
                </div>
                <div class="flex justify-center gap-4">
                    <button id="confirmPdfBtn" class="btn-action btn-confirm flex items-center justify-center">
                        <span id="confirmBtnText">Konfirmasi & Buat PDF</span>
                        <svg id="confirmBtnLoader" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                    <button id="cancelPdfBtn" class="btn-action btn-cancel">Batal</button>
                </div>
            </div>
            <!-- Loader Section -->
            <div id="loaderSection" class="hidden text-center">
                <svg class="animate-spin h-16 w-16 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-lg font-semibold text-gray-700">Membuat PDF, mohon tunggu...</p>
            </div>
        </div>
    </div>

    <script>
        // Ensure jsPDF is available globally
        const { jsPDF } = window.jspdf;

        // Cropper instances array
        let croppers = [];
        const MAX_IMAGES = 6;

        // User data
        let userData = {};
        
        // History pagination
        let historyPage = 1;
        const ITEMS_PER_PAGE = 5;

        // DOM Elements
        const pageHeader = document.getElementById('pageHeader');
        const pageFooter = document.getElementById('pageFooter');
        const imageGridContainer = document.getElementById('imageGridContainer');
        const namaKegiatanInput = document.getElementById('namaKegiatan');
        const previewBtn = document.getElementById('previewBtn');
        const previewBtnIcon = document.getElementById('previewBtnIcon');
        const previewBtnLoader = document.getElementById('previewBtnLoader');
        const infoText = document.getElementById('infoText');
        
        // Wilayah Modal Elements
        const wilayahModal = document.getElementById('wilayahModal');
        const namaLengkapInput = document.getElementById('namaLengkap');
        const provinsiSelect = document.getElementById('provinsi');
        const kabupatenSelect = document.getElementById('kabupaten');
        const kecamatanSelect = document.getElementById('kecamatan');
        const desaSelect = document.getElementById('desa');
        const simpanWilayahBtn = document.getElementById('simpanWilayahBtn');
        const simpanBtnText = document.getElementById('simpanBtnText');
        const simpanBtnLoader = document.getElementById('simpanBtnLoader');
        
        // Header Info Elements
        const userInfoContainer = document.getElementById('userInfoContainer');
        const logoutBtn = document.getElementById('logoutBtn');
        const historyBtn = document.getElementById('historyBtn');

        // History Modal Elements
        const historyModal = document.getElementById('historyModal');
        const closeHistoryBtn = document.getElementById('closeHistoryBtn');
        const historyTableBody = document.getElementById('historyTableBody');
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        const loadMoreText = document.getElementById('loadMoreText');
        const loadMoreLoader = document.getElementById('loadMoreLoader');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        const historyActionLoader = document.getElementById('historyActionLoader');

        // Main Modal Elements
        const modal = document.getElementById('modal');
        const previewSection = document.getElementById('previewSection');
        const previewImageContainer = document.getElementById('previewImageContainer');
        const loaderSection = document.getElementById('loaderSection');
        const confirmPdfBtn = document.getElementById('confirmPdfBtn');
        const confirmBtnText = document.getElementById('confirmBtnText');
        const confirmBtnLoader = document.getElementById('confirmBtnLoader');
        const cancelPdfBtn = document.getElementById('cancelPdfBtn');
        const cropLockToggle = document.getElementById('cropLockToggle');

        const handleLoginState = (data) => {
            userData = data;
            userInfoContainer.classList.remove('hidden');
            userInfoContainer.classList.add('flex');
            wilayahModal.classList.add('hidden');
        };

        const handleLogoutState = () => {
            userInfoContainer.classList.add('hidden');
            userInfoContainer.classList.remove('flex');
            wilayahModal.classList.remove('hidden');
        };

        // Trigger animations and check session on page load
        document.addEventListener('DOMContentLoaded', () => {
            pageHeader.classList.add('animate-slide-down');
            pageFooter.classList.add('animate-slide-up');
            
            // Generate image upload slots
            for (let i = 1; i <= MAX_IMAGES; i++) {
                const slot = document.createElement('div');
                slot.className = 'space-y-2';
                slot.innerHTML = `
                    <h2 class="text-xl font-semibold text-center">Gambar ${i}</h2>
                    <div>
                        <label for="visualName${i}" class="block text-sm font-medium text-gray-700">Nama Visual</label>
                        <textarea id="visualName${i}" rows="4" cols="50" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm uppercase" oninput="this.value = this.value.toUpperCase()"></textarea>
                    </div>
                    <div id="previewContainer${i}" class="preview-container">
                        <img id="image${i}">
                    </div>
                    <div class="text-center">
                        <label for="imageUpload${i}" class="upload-label">Pilih Gambar ${i}</label>
                        <input type="file" id="imageUpload${i}" class="hidden" accept="image/*">
                    </div>
                `;
                imageGridContainer.appendChild(slot);
                setupCropper(document.getElementById(`imageUpload${i}`), document.getElementById(`image${i}`), i - 1);
            }

            // Set initial crop lock state
            if (cropLockToggle.checked) {
                imageGridContainer.classList.add('crop-locked');
            }

            const storedUserData = localStorage.getItem('userData');
            if (storedUserData) {
                handleLoginState(JSON.parse(storedUserData));
            } else {
                handleLogoutState();
            }
        });

        const validateField = (input, validationFn) => {
            input.classList.remove('border-gray-300', 'border-red-500', 'border-green-500', 'focus:ring-indigo-500', 'focus:ring-red-500', 'focus:ring-green-500');
            if (validationFn(input.value)) {
                input.classList.add('border-green-500', 'focus:ring-green-500');
                return true;
            } else {
                input.classList.add('border-red-500', 'focus:ring-red-500');
                return false;
            }
        };

        const isNotEmpty = value => value.trim() !== '';

        // Function to validate the "Nama Kegiatan" input
        const validateNamaKegiatan = () => validateField(namaKegiatanInput, isNotEmpty);

        // Function to validate Wilayah Modal fields
        const validateNamaLengkap = () => validateField(namaLengkapInput, isNotEmpty);
        const validateDesa = () => validateField(desaSelect, isNotEmpty);

        // Function to handle image upload and initialize cropper
        const setupCropper = (inputElement, imageElement, index) => {
            const previewContainer = document.getElementById(`previewContainer${index + 1}`);

            inputElement.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // Create and show loader
                const loader = document.createElement('div');
                loader.className = 'absolute inset-0 bg-gray-100 bg-opacity-75 flex items-center justify-center rounded-lg';
                loader.innerHTML = `<svg class="animate-spin h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
                previewContainer.style.position = 'relative'; // Ensure parent is relative
                previewContainer.appendChild(loader);

                const reader = new FileReader();
                reader.onload = (event) => {
                    imageElement.src = event.target.result;
                    imageElement.dataset.originalSrc = event.target.result; // Store original image data
                    
                    if (croppers[index]) croppers[index].destroy();

                    croppers[index] = new Cropper(imageElement, {
                        aspectRatio: 4 / 3,
                        viewMode: 1,
                        background: false,
                        autoCropArea: 0.9,
                        responsive: true,
                        dragMode: cropLockToggle.checked ? 'move' : 'crop',
                        ready: () => {
                            // Hide loader when cropper is ready
                            if (previewContainer.contains(loader)) {
                                previewContainer.removeChild(loader);
                            }
                            updateButtonState();
                        },
                    });
                };
                reader.readAsDataURL(file);
            });
        };

        // Function to reset the entire form for editing
        const resetForm = () => {
            namaKegiatanInput.value = '';
            for (let i = 0; i < MAX_IMAGES; i++) {
                if (croppers[i]) {
                    croppers[i].destroy();
                }
                const imageElement = document.getElementById(`image${i + 1}`);
                const inputElement = document.getElementById(`imageUpload${i + 1}`);
                const visualNameElement = document.getElementById(`visualName${i + 1}`);
                
                imageElement.src = '';
                croppers[i] = undefined; 
                
                if (imageElement.dataset.originalSrc) {
                     delete imageElement.dataset.originalSrc;
                }
               
                inputElement.value = ''; 
                visualNameElement.value = '';
            }
            updateButtonState();
        };


        // Function to update the generate button's state
        const updateButtonState = () => {
            const activeCroppers = croppers.filter(c => c).length;
            if (activeCroppers >= 1) {
                previewBtn.disabled = false;
                infoText.style.display = 'none';
            } else {
                previewBtn.disabled = true;
                infoText.style.display = 'block';
            }
        };

        const resetPreviewButton = () => {
            previewBtn.disabled = false;
            previewBtnIcon.classList.remove('hidden');
            previewBtnLoader.classList.add('hidden');
        };

        // Function to show the preview modal
        const showPreview = () => {
            if (!validateNamaKegiatan()) {
                iziToast.error({ title: 'Gagal', message: 'Nama kegiatan tidak boleh kosong.', position: 'topRight' });
                resetPreviewButton();
                return;
            }

            const activeCroppers = croppers.filter(c => c);
            if (activeCroppers.length < 1) {
                 iziToast.error({ title: 'Gagal', message: 'Harap unggah minimal 1 gambar.', position: 'topRight' });
                 resetPreviewButton();
                return;
            }
            
            previewImageContainer.innerHTML = '';
            activeCroppers.forEach(cropper => {
                const img = document.createElement('img');
                img.src = cropper.getCroppedCanvas().toDataURL();
                img.className = 'max-w-full border-4 border-gray-200 rounded-lg shadow-md';
                previewImageContainer.appendChild(img);
            });

            loaderSection.classList.add('hidden');
            previewSection.classList.remove('hidden');
            modal.classList.remove('hidden');
            resetPreviewButton();
        };
        
        const resetConfirmModal = () => {
            confirmPdfBtn.disabled = false;
            confirmBtnText.classList.remove('hidden');
            confirmBtnLoader.classList.add('hidden');
            cancelPdfBtn.disabled = false;
        };
        
        // Function to generate the PDF
        const generatePdf = async () => {
            previewSection.classList.add('hidden');
            loaderSection.classList.remove('hidden');

            const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
            const namaKegiatan = namaKegiatanInput.value;
            
            const historyEntry = {
                namaKegiatan: namaKegiatan,
                images: [],
                tanggal: new Date().toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' })
            };

            const activeImages = croppers.map((cropper, index) => {
                if (cropper) {
                    const imageElement = document.getElementById(`image${index + 1}`);
                    return {
                        cropper: cropper,
                        visualName: document.getElementById(`visualName${index + 1}`).value || `Gambar ${index + 1}`,
                        originalSrc: imageElement.dataset.originalSrc,
                        cropData: cropper.getData()
                    };
                }
                return null;
            }).filter(Boolean);

            historyEntry.images = activeImages.map(d => ({
                visualName: d.visualName,
                originalSrc: d.originalSrc,
                cropData: d.cropData
            }));


            // Main Title
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text('DOKUMENTASI KEGIATAN', 105, 15, { align: 'center' });
            
            // Sub Title (Nama Kegiatan)
            doc.setFontSize(14);
            doc.setFont('helvetica', 'normal');
            doc.text(namaKegiatan, 105, 23, { align: 'center' });
            
            // Wilayah Info
            doc.setFontSize(10);
            const userInfo = `Desa ${userData.desa}, Kec. ${userData.kecamatan}, Kab. ${userData.kabupaten}`;
            doc.text(userInfo, 105, 30, { align: 'center' });

            let imgWidth, imgHeight;
            if (activeImages.length === 1) {
                imgWidth = 150; // 15 cm
                imgHeight = 100; // 10 cm
                let y = 40;
                const x = (210 - imgWidth) / 2;
                activeImages.forEach((imgData, index) => {
                    doc.setFontSize(9);
                    doc.text(imgData.visualName, x, y - 5);
                    const canvas = imgData.cropper.getCroppedCanvas({ width: 1200, height: 800 });
                    doc.addImage(canvas.toDataURL('image/jpeg', 0.9), 'JPEG', x, y, imgWidth, imgHeight);
                });
            } else if (activeImages.length === 2) {
                imgWidth = 150; // 15 cm
                imgHeight = 100; // 10 cm
                let y = 40;
                const x = (210 - imgWidth) / 2;
                activeImages.forEach((imgData, index) => {
                    if (index === 1) y += imgHeight + 15; // Add space
                    doc.setFontSize(9);
                    doc.text(imgData.visualName, x, y - 5);
                    const canvas = imgData.cropper.getCroppedCanvas({ width: 1200, height: 800 });
                    doc.addImage(canvas.toDataURL('image/jpeg', 0.9), 'JPEG', x, y, imgWidth, imgHeight);
                });
            } else if (activeImages.length === 3) {
                imgWidth = 110; // 11 cm
                imgHeight = 60; // 6 cm
                let y = 40;
                const x = (210 - imgWidth) / 2;
                activeImages.forEach((imgData, index) => {
                    if (index > 0) y += imgHeight + 15;
                    doc.setFontSize(9);
                    doc.text(imgData.visualName, x, y - 5);
                    const canvas = imgData.cropper.getCroppedCanvas({ width: 1200, height: 720 });
                    doc.addImage(canvas.toDataURL('image/jpeg', 0.9), 'JPEG', x, y, imgWidth, imgHeight);
                });
            } else { // For 4 to 6 images
                imgWidth = 80; // 8 cm
                imgHeight = 50; // 5 cm
                let y = 40;
                const x1 = 20;
                const x2 = 115;
                activeImages.forEach((imgData, index) => {
                    const x = (index % 2 === 0) ? x1 : x2;
                    if (index > 0 && index % 2 === 0) y += imgHeight + 15;
                    
                    doc.setFontSize(9);
                    doc.text(imgData.visualName, x, y - 5);
                    const canvas = imgData.cropper.getCroppedCanvas({ width: 1200, height: 750 });
                    doc.addImage(canvas.toDataURL('image/jpeg', 0.9), 'JPEG', x, y, imgWidth, imgHeight);
                });
            }
            
            const pdfDataUri = doc.output('datauristring');
            const fileName = `Dokumentasi - ${namaKegiatan.replace(/ /g, '_')}.pdf`;
            
            historyEntry.pdfData = pdfDataUri;
            historyEntry.fileName = fileName;

            setTimeout(() => {
                doc.save(fileName);
                modal.classList.add('hidden');
                resetConfirmModal(); 
                iziToast.success({ title: 'Berhasil', message: `PDF "${fileName}" telah dibuat.`, position: 'topRight' });
                let history = JSON.parse(localStorage.getItem('pdfHistory')) || [];
                history.unshift(historyEntry);
                localStorage.setItem('pdfHistory', JSON.stringify(history));
            }, 500);
        };

        const displayHistoryPage = () => {
            const history = JSON.parse(localStorage.getItem('pdfHistory')) || [];
            const totalItems = historyPage * ITEMS_PER_PAGE;
            const itemsToDisplay = history.slice(0, totalItems);
            
            historyTableBody.innerHTML = ''; // Clear previous entries

            if (itemsToDisplay.length === 0) {
                historyTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4">Belum ada riwayat.</td></tr>`;
                loadMoreBtn.classList.add('hidden');
                return;
            }

            itemsToDisplay.forEach((item, index) => {
                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="p-4">
                            <input type="checkbox" class="history-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded" data-index="${index}">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.namaKegiatan}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.tanggal}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 space-x-2">
                            <button class="edit-btn text-green-600 hover:text-green-800" data-index="${index}">Edit</button>
                            <button class="download-btn text-blue-600 hover:text-blue-800" data-index="${index}">Unduh</button>
                            <button class="delete-btn text-red-600 hover:text-red-800" data-index="${index}">Hapus</button>
                        </td>
                    </tr>
                `;
                historyTableBody.innerHTML += row;
            });

            if (history.length > totalItems) {
                loadMoreBtn.classList.remove('hidden');
            } else {
                loadMoreBtn.classList.add('hidden');
            }
            updateDeleteSelectedButtonState();
        };

        const updateDeleteSelectedButtonState = () => {
            const checkedBoxes = document.querySelectorAll('.history-checkbox:checked');
            if (checkedBoxes.length > 0) {
                deleteSelectedBtn.classList.remove('hidden');
            } else {
                deleteSelectedBtn.classList.add('hidden');
            }
        };

        // Event Listeners
        namaKegiatanInput.addEventListener('input', validateNamaKegiatan);
        
        cropLockToggle.addEventListener('change', () => {
            if (cropLockToggle.checked) {
                imageGridContainer.classList.add('crop-locked');
                croppers.forEach(cropper => {
                    if (cropper) {
                        cropper.setDragMode('move');
                    }
                });
            } else {
                imageGridContainer.classList.remove('crop-locked');
                croppers.forEach(cropper => {
                    if (cropper) {
                        cropper.setDragMode('crop');
                    }
                });
            }
        });

        previewBtn.addEventListener('click', () => {
            previewBtn.disabled = true;
            previewBtnIcon.classList.add('hidden');
            previewBtnLoader.classList.remove('hidden');

            // Give UI time to update before heavy processing
            setTimeout(() => {
                showPreview();
            }, 100);
        });
        
        confirmPdfBtn.addEventListener('click', () => {
            confirmPdfBtn.disabled = true;
            confirmBtnText.classList.add('hidden');
            confirmBtnLoader.classList.remove('hidden');
            cancelPdfBtn.disabled = true;

            // Give UI time to update before heavy processing
            setTimeout(() => {
                generatePdf();
            }, 100);
        });

        cancelPdfBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            resetConfirmModal();
        });
        
        namaLengkapInput.addEventListener('input', validateNamaLengkap);
        desaSelect.addEventListener('change', validateDesa);

        simpanWilayahBtn.addEventListener('click', () => {
            simpanBtnText.classList.add('hidden');
            simpanBtnLoader.classList.remove('hidden');
            simpanWilayahBtn.disabled = true;

            const isNamaValid = validateNamaLengkap();
            const isDesaValid = validateDesa();
            
            setTimeout(() => {
                if (!isNamaValid || !isDesaValid) {
                    if (!isNamaValid) iziToast.error({ title: 'Gagal', message: 'Nama lengkap tidak boleh kosong.', position: 'topRight' });
                    if (!isDesaValid) iziToast.error({ title: 'Gagal', message: 'Silakan pilih desa/kelurahan.', position: 'topRight' });
                    
                    simpanBtnText.classList.remove('hidden');
                    simpanBtnLoader.classList.add('hidden');
                    simpanWilayahBtn.disabled = false;
                    return;
                }
                
                const currentUserData = {
                    namaLengkap: namaLengkapInput.value.trim(),
                    provinsi: provinsiSelect.value,
                    kabupaten: kabupatenSelect.value,
                    kecamatan: kecamatanSelect.value,
                    desa: desaSelect.value
                };

                localStorage.setItem('userData', JSON.stringify(currentUserData));
                handleLoginState(currentUserData);
            }, 500);
        });

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('userData');
            localStorage.removeItem('pdfHistory');
            iziToast.info({
                title: 'Logout',
                message: 'Anda telah berhasil logout.',
                position: 'topRight'
            });
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        });

        historyBtn.addEventListener('click', () => {
            historyPage = 1;
            displayHistoryPage();
            historyModal.classList.remove('hidden');
        });

        closeHistoryBtn.addEventListener('click', () => {
            historyModal.classList.add('hidden');
        });

        loadMoreBtn.addEventListener('click', () => {
            loadMoreText.classList.add('hidden');
            loadMoreLoader.classList.remove('hidden');
            loadMoreBtn.disabled = true;

            setTimeout(() => {
                historyPage++;
                displayHistoryPage();
                loadMoreText.classList.remove('hidden');
                loadMoreLoader.classList.add('hidden');
                loadMoreBtn.disabled = false;
            }, 500);
        });

        historyTableBody.addEventListener('click', (e) => {
            const history = JSON.parse(localStorage.getItem('pdfHistory')) || [];
            const index = e.target.dataset.index;

            if (e.target.classList.contains('download-btn')) {
                const item = history[index];
                if (item && item.pdfData) {
                    const link = document.createElement('a');
                    link.href = item.pdfData;
                    link.download = item.fileName || 'Dokumentasi.pdf';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    iziToast.success({ title: 'Berhasil', message: `Mengunduh ulang ${link.download}.`, position: 'topRight' });
                } else {
                    iziToast.error({ title: 'Gagal', message: 'Data PDF tidak ditemukan.', position: 'topRight' });
                }
            } else if (e.target.classList.contains('edit-btn')) {
                const item = history[index];
                if (!item || !item.images || item.images.length === 0) {
                    iziToast.error({ title: 'Gagal', message: 'Data riwayat ini tidak lengkap dan tidak dapat diedit.', position: 'topRight' });
                    return;
                }

                iziToast.question({
                    timeout: 20000,
                    close: false,
                    overlay: true,
                    displayMode: 'once',
                    id: 'question',
                    zindex: 9999,
                    title: 'Konfirmasi Edit',
                    message: 'Ini akan mengganti data saat ini di form. Lanjutkan?',
                    position: 'center',
                    buttons: [
                        ['<button><b>YA</b></button>', function (instance, toast) {
                            instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');
                            resetForm();
                            namaKegiatanInput.value = item.namaKegiatan;

                            item.images.forEach((imgData, i) => {
                                const imageElement = document.getElementById(`image${i + 1}`);
                                const visualNameElement = document.getElementById(`visualName${i + 1}`);

                                visualNameElement.value = imgData.visualName;
                                imageElement.dataset.originalSrc = imgData.originalSrc;
                                imageElement.src = imgData.originalSrc;

                                if (croppers[i]) {
                                    croppers[i].destroy();
                                }

                                croppers[i] = new Cropper(imageElement, {
                                    aspectRatio: 4 / 3,
                                    viewMode: 1,
                                    background: false,
                                    autoCropArea: 0.9,
                                    responsive: true,
                                    ready: () => {
                                        croppers[i].setData(imgData.cropData);
                                        updateButtonState();
                                    },
                                });
                            });

                            historyModal.classList.add('hidden');
                            iziToast.info({ title: 'Info', message: 'Data telah dimuat ke form untuk diedit.', position: 'topRight' });
                        }, true],
                        ['<button>TIDAK</button>', function (instance, toast) {
                            instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');
                        }],
                    ],
                });
            } else if (e.target.classList.contains('delete-btn')) {
                iziToast.question({
                    timeout: 20000,
                    close: false,
                    overlay: true,
                    displayMode: 'once',
                    id: 'question',
                    zindex: 9999,
                    title: 'Konfirmasi',
                    message: 'Apakah Anda yakin ingin menghapus riwayat ini?',
                    position: 'center',
                    buttons: [
                        ['<button><b>YA</b></button>', function (instance, toast) {
                            instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');
                            historyActionLoader.classList.remove('hidden');
                            setTimeout(() => {
                                history.splice(index, 1);
                                localStorage.setItem('pdfHistory', JSON.stringify(history));
                                displayHistoryPage();
                                historyActionLoader.classList.add('hidden');
                                iziToast.success({ title: 'Berhasil', message: 'Riwayat telah dihapus.', position: 'topRight' });
                            }, 500);
                        }, true],
                        ['<button>TIDAK</button>', function (instance, toast) {
                            instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');
                        }],
                    ],
                });
            } else if (e.target.classList.contains('history-checkbox')) {
                updateDeleteSelectedButtonState();
            }
        });

        selectAllCheckbox.addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('.history-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = e.target.checked);
            updateDeleteSelectedButtonState();
        });

        deleteSelectedBtn.addEventListener('click', () => {
            const checkedBoxes = document.querySelectorAll('.history-checkbox:checked');
            const indicesToDelete = Array.from(checkedBoxes).map(cb => parseInt(cb.dataset.index));

            iziToast.question({
                timeout: 20000,
                close: false,
                overlay: true,
                displayMode: 'once',
                id: 'question',
                zindex: 9999,
                title: 'Konfirmasi',
                message: `Apakah Anda yakin ingin menghapus ${indicesToDelete.length} riwayat terpilih?`,
                position: 'center',
                buttons: [
                    ['<button><b>YA</b></button>', function (instance, toast) {
                        instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');
                        historyActionLoader.classList.remove('hidden');
                        setTimeout(() => {
                            let history = JSON.parse(localStorage.getItem('pdfHistory')) || [];
                            const newHistory = history.filter((_, index) => !indicesToDelete.includes(index));
                            localStorage.setItem('pdfHistory', JSON.stringify(newHistory));
                            displayHistoryPage();
                            historyActionLoader.classList.add('hidden');
                            iziToast.success({ title: 'Berhasil', message: 'Riwayat terpilih telah dihapus.', position: 'topRight' });
                        }, 500);
                    }, true],
                    ['<button>TIDAK</button>', function (instance, toast) {
                        instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');
                    }],
                ],
            });
        });

    </script>
</body>
</html>

