<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDIP | Buat Dokumentasi</title>
    
    <!-- Shortcut Icon -->
    <link rel="shortcut icon" href="https://newsiga-siga.bkkbn.go.id/icon_bkkbn.png">

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Cropper.js for image cropping -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

    <!-- Import iziToast untuk notifikasi -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/css/iziToast.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/js/iziToast.min.js"></script>

    <style>
        /* Custom styles for a better look and feel */
        body {
            font-family: 'Inter', sans-serif;
            padding-top: 80px; /* Add padding to the top to prevent header overlap */
            padding-bottom: 80px; /* Add padding to the bottom to prevent footer overlap */
        }
        .preview-container {
            width: 100%;
            height: 300px; /* Fixed height for the container */
            background-color: #f0f4f8;
            border: 2px dashed #cbd5e1;
            overflow: hidden;
            border-radius: 0.5rem;
        }
        /* This rule is important for cropper.js to display correctly */
        .preview-container img {
            max-width: 100%;
            max-height: 100%;
        }
        .upload-label {
            cursor: pointer;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            background-color: #4f46e5;
            color: white;
            transition: background-color 0.3s;
        }
        .upload-label:hover {
            background-color: #4338ca;
        }
        .btn-action {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            color: white;
            transition: background-color 0.3s, transform 0.2s;
        }
        .btn-action:hover {
            transform: scale(1.05);
        }
        .btn-action:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        .btn-generate {
            background-color: #16a34a;
        }
        .btn-generate:hover {
            background-color: #15803d;
        }
        .btn-confirm {
            background-color: #2563eb;
        }
        .btn-confirm:hover {
             background-color: #1d4ed8;
        }
        .btn-cancel {
            background-color: #6b7280;
        }
        .btn-cancel:hover {
            background-color: #4b5563;
        }

        /* Animation Keyframes */
        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        /* Animation Classes */
        .animate-slide-down {
            animation: slideDown 0.7s ease-out forwards;
        }

        .animate-slide-up {
            animation: slideUp 0.7s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col min-h-screen">

    <!-- Header -->
    <header id="pageHeader" class="bg-white shadow-md w-full fixed top-0 left-0 right-0 z-50" style="transform: translateY(-100%);">
        <div class="container mx-auto p-4 flex justify-between items-center">
            <a href="https://balaipenyuluhankbciemas.github.io/edip/" title="Kembali ke Menu" class="flex items-center gap-2 text-gray-700 hover:text-indigo-600 transition-colors w-fit">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                <span class="font-semibold">Kembali ke Menu</span>
            </a>
            <div id="userInfoContainer" class="hidden items-center gap-2 md:gap-4">
                 <span id="userInfoText" class="font-semibold text-gray-700 text-sm md:text-base"></span>
                 <button id="historyBtn" class="btn-action bg-blue-600 hover:bg-blue-700 px-3 py-2 text-sm">Riwayat</button>
                 <button id="logoutBtn" class="btn-action bg-red-600 hover:bg-red-700 px-3 py-2 text-sm">Logout</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl">
            <div class="bg-white p-8 rounded-2xl shadow-lg">
                
                <!-- Page Title -->
                <div class="text-center mb-6">
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">DOKUMENTASI KEGIATAN</h1>
                    <p class="text-gray-600 mt-2">Unggah 2 gambar, sesuaikan ukurannya, dan cetak sebagai PDF.</p>
                </div>

                <!-- Nama Kegiatan Input -->
                <div class="mb-8 max-w-xl mx-auto">
                    <label for="namaKegiatan" class="block text-sm font-medium text-gray-700 mb-2">NAMA KEGIATAN</label>
                    <input type="text" id="namaKegiatan" name="namaKegiatan" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm transition-colors duration-300 focus:ring-2 uppercase" placeholder="CONTOH: POSYANDU/PENYULUHAN/MBG" oninput="this.value = this.value.toUpperCase()">
                </div>

                <!-- Image Upload and Crop Section -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Image 1 -->
                    <div class="space-y-4">
                        <h2 class="text-xl font-semibold text-center">Gambar 1</h2>
                        <div id="previewContainer1" class="preview-container">
                            <img id="image1">
                        </div>
                        <div class="text-center">
                            <label for="imageUpload1" class="upload-label">Pilih Gambar 1</label>
                            <input type="file" id="imageUpload1" class="hidden" accept="image/*">
                        </div>
                    </div>

                    <!-- Image 2 -->
                    <div class="space-y-4">
                        <h2 class="text-xl font-semibold text-center">Gambar 2</h2>
                        <div id="previewContainer2" class="preview-container">
                            <img id="image2">
                        </div>
                         <div class="text-center">
                            <label for="imageUpload2" class="upload-label">Pilih Gambar 2</label>
                            <input type="file" id="imageUpload2" class="hidden" accept="image/*">
                        </div>
                    </div>
                </div>

                <!-- Action Button -->
                <div class="mt-10 text-center">
                    <button id="previewBtn" class="w-full md:w-auto px-8 py-4 text-lg btn-action btn-generate" disabled>
                        Buat PDF
                    </button>
                    <p id="infoText" class="text-sm text-gray-500 mt-3">Silakan unggah 2 gambar untuk membuat PDF.</p>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer id="pageFooter" class="fixed bottom-0 left-0 right-0 bg-gray-800 text-white z-50" style="transform: translateY(100%);">
        <div class="container mx-auto px-6 py-4 text-center">
            <p>&copy; 2025 Smysnie - Edip.</p>
        </div>
    </footer>

    <!-- Wilayah Selection Modal -->
    <div id="wilayahModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-[100] flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md space-y-6">
            <h2 class="text-2xl font-bold text-center text-gray-900">Pilih Wilayah Kerja</h2>
            <div class="space-y-4">
                <div>
                    <label for="namaLengkap" class="block text-sm font-medium text-gray-700">NAMA LENGKAP</label>
                    <input type="text" id="namaLengkap" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 uppercase transition-colors duration-300" oninput="this.value = this.value.toUpperCase()">
                </div>
                <div>
                    <label for="provinsi" class="block text-sm font-medium text-gray-700">PROVINSI</label>
                    <select id="provinsi" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md bg-gray-100" disabled>
                        <option selected>JAWA BARAT</option>
                    </select>
                </div>
                <div>
                    <label for="kabupaten" class="block text-sm font-medium text-gray-700">KAB/KOTA</label>
                    <select id="kabupaten" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md bg-gray-100" disabled>
                        <option selected>SUKABUMI</option>
                    </select>
                </div>
                <div>
                    <label for="kecamatan" class="block text-sm font-medium text-gray-700">KECAMATAN</label>
                    <select id="kecamatan" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md bg-gray-100" disabled>
                        <option selected>CIEMAS</option>
                    </select>
                </div>
                <div>
                    <label for="desa" class="block text-sm font-medium text-gray-700">DESA/KELURAHAN</label>
                    <select id="desa" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-2 sm:text-sm rounded-md transition-colors duration-300">
                        <option value="" disabled selected>-- Pilih Desa --</option>
                        <option value="CIEMAS">CIEMAS</option>
                        <option value="CIBENDA">CIBENDA</option>
                        <option value="CIWARU">CIWARU</option>
                        <option value="MEKARJAYA">MEKARJAYA</option>
                        <option value="GIRIMUKTI">GIRIMUKTI</option>
                        <option value="TAMANJAYA">TAMANJAYA</option>
                        <option value="MANDRAJAYA">MANDRAJAYA</option>
                        <option value="SIDAMULYA">SIDAMULYA</option>
                        <option value="MEKARSAKTI">MEKARSAKTI</option>
                    </select>
                </div>
            </div>
            <button id="simpanWilayahBtn" class="w-full btn-action btn-confirm flex items-center justify-center">
                <span id="simpanBtnText">Simpan & Lanjutkan</span>
                <svg id="simpanBtnLoader" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-[100] flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-3xl space-y-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <h2 class="text-2xl font-bold text-gray-900">Riwayat Pembuatan PDF</h2>
                    <button id="deleteSelectedBtn" class="hidden btn-action bg-red-600 hover:bg-red-700 px-3 py-2 text-sm">Hapus Terpilih</button>
                </div>
                <button id="closeHistoryBtn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="overflow-x-auto max-h-96">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="p-4">
                                <input type="checkbox" id="selectAllCheckbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Kegiatan</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Dibuat</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- History data will be inserted here -->
                    </tbody>
                </table>
            </div>
            <div id="historyLoaderContainer" class="text-center">
                <button id="loadMoreBtn" class="w-full btn-action bg-gray-600 hover:bg-gray-700 flex items-center justify-center">
                    <span id="loadMoreText">Lihat Data Selanjutnya</span>
                    <svg id="loadMoreLoader" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>


    <!-- Modal for Preview and Loader -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
        <div id="modalContent" class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl w-full max-w-3xl">
            <!-- Preview Section -->
            <div id="previewSection">
                <h3 class="text-2xl font-bold mb-6 text-center text-gray-800">Pratinjau PDF</h3>
                <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-8">
                    <img id="previewImg1" class="hidden max-w-full sm:max-w-xs border-4 border-gray-200 rounded-lg shadow-md">
                    <img id="previewImg2" class="hidden max-w-full sm:max-w-xs border-4 border-gray-200 rounded-lg shadow-md">
                </div>
                <div class="flex justify-center gap-4">
                    <button id="confirmPdfBtn" class="btn-action btn-confirm">Konfirmasi & Buat PDF</button>
                    <button id="cancelPdfBtn" class="btn-action btn-cancel">Batal</button>
                </div>
            </div>
            <!-- Loader Section -->
            <div id="loaderSection" class="hidden text-center">
                <svg class="animate-spin h-16 w-16 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-lg font-semibold text-gray-700">Membuat PDF, mohon tunggu...</p>
            </div>
        </div>
    </div>

    <script>
        // Ensure jsPDF is available globally
        const { jsPDF } = window.jspdf;

        // Cropper instances
        let cropper1 = null;
        let cropper2 = null;

        // User data
        let userData = {};
        
        // History pagination
        let historyPage = 1;
        const ITEMS_PER_PAGE = 5;

        // DOM Elements
        const pageHeader = document.getElementById('pageHeader');
        const pageFooter = document.getElementById('pageFooter');
        const imageUpload1 = document.getElementById('imageUpload1');
        const imageUpload2 = document.getElementById('imageUpload2');
        const image1 = document.getElementById('image1');
        const image2 = document.getElementById('image2');
        const namaKegiatanInput = document.getElementById('namaKegiatan');
        const previewBtn = document.getElementById('previewBtn');
        const infoText = document.getElementById('infoText');
        
        // Wilayah Modal Elements
        const wilayahModal = document.getElementById('wilayahModal');
        const namaLengkapInput = document.getElementById('namaLengkap');
        const provinsiSelect = document.getElementById('provinsi');
        const kabupatenSelect = document.getElementById('kabupaten');
        const kecamatanSelect = document.getElementById('kecamatan');
        const desaSelect = document.getElementById('desa');
        const simpanWilayahBtn = document.getElementById('simpanWilayahBtn');
        const simpanBtnText = document.getElementById('simpanBtnText');
        const simpanBtnLoader = document.getElementById('simpanBtnLoader');
        
        // Header Info Elements
        const userInfoContainer = document.getElementById('userInfoContainer');
        const userInfoText = document.getElementById('userInfoText');
        const logoutBtn = document.getElementById('logoutBtn');
        const historyBtn = document.getElementById('historyBtn');

        // History Modal Elements
        const historyModal = document.getElementById('historyModal');
        const closeHistoryBtn = document.getElementById('closeHistoryBtn');
        const historyTableBody = document.getElementById('historyTableBody');
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        const loadMoreText = document.getElementById('loadMoreText');
        const loadMoreLoader = document.getElementById('loadMoreLoader');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');

        // Main Modal Elements
        const modal = document.getElementById('modal');
        const previewSection = document.getElementById('previewSection');
        const loaderSection = document.getElementById('loaderSection');
        const previewImg1 = document.getElementById('previewImg1');
        const previewImg2 = document.getElementById('previewImg2');
        const confirmPdfBtn = document.getElementById('confirmPdfBtn');
        const cancelPdfBtn = document.getElementById('cancelPdfBtn');

        const handleLoginState = (data) => {
            userData = data;
            userInfoText.textContent = `Selamat Datang, ${data.namaLengkap}`;
            userInfoContainer.classList.remove('hidden');
            userInfoContainer.classList.add('flex');
            wilayahModal.classList.add('hidden');
        };

        const handleLogoutState = () => {
            userInfoContainer.classList.add('hidden');
            userInfoContainer.classList.remove('flex');
            wilayahModal.classList.remove('hidden');
        };

        // Trigger animations and check session on page load
        document.addEventListener('DOMContentLoaded', () => {
            pageHeader.classList.add('animate-slide-down');
            pageFooter.classList.add('animate-slide-up');

            const storedUserData = localStorage.getItem('userData');
            if (storedUserData) {
                handleLoginState(JSON.parse(storedUserData));
            } else {
                handleLogoutState();
            }
        });

        const validateField = (input, validationFn) => {
            input.classList.remove('border-gray-300', 'border-red-500', 'border-green-500', 'focus:ring-indigo-500', 'focus:ring-red-500', 'focus:ring-green-500');
            if (validationFn(input.value)) {
                input.classList.add('border-green-500', 'focus:ring-green-500');
                return true;
            } else {
                input.classList.add('border-red-500', 'focus:ring-red-500');
                return false;
            }
        };

        const isNotEmpty = value => value.trim() !== '';

        // Function to validate the "Nama Kegiatan" input
        const validateNamaKegiatan = () => validateField(namaKegiatanInput, isNotEmpty);

        // Function to validate Wilayah Modal fields
        const validateNamaLengkap = () => validateField(namaLengkapInput, isNotEmpty);
        const validateDesa = () => validateField(desaSelect, isNotEmpty);

        // Function to handle image upload and initialize cropper
        const setupCropper = (inputElement, imageElement, cropperVarName) => {
            inputElement.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    imageElement.src = event.target.result;

                    if (cropperVarName === 'cropper1' && cropper1) cropper1.destroy();
                    if (cropperVarName === 'cropper2' && cropper2) cropper2.destroy();

                    const cropper = new Cropper(imageElement, {
                        aspectRatio: 4 / 3,
                        viewMode: 1,
                        background: false,
                        autoCropArea: 0.9,
                        responsive: true,
                        ready: updateButtonState,
                    });

                    if (cropperVarName === 'cropper1') cropper1 = cropper;
                    else cropper2 = cropper;
                };
                reader.readAsDataURL(file);
            });
        };

        setupCropper(imageUpload1, image1, 'cropper1');
        setupCropper(imageUpload2, image2, 'cropper2');

        // Function to update the generate button's state
        const updateButtonState = () => {
            // Enable button only when BOTH images are uploaded
            if (cropper1 && cropper2) {
                previewBtn.disabled = false;
                infoText.style.display = 'none';
            } else {
                previewBtn.disabled = true;
                infoText.style.display = 'block';
            }
        };

        // Function to show the preview modal
        const showPreview = () => {
            if (!validateNamaKegiatan()) {
                iziToast.error({
                    title: 'Gagal',
                    message: 'Nama kegiatan tidak boleh kosong.',
                    position: 'topRight'
                });
                return;
            }

            // Add check for both images
            if (!cropper1 || !cropper2) {
                 iziToast.error({
                    title: 'Gagal',
                    message: 'Harap unggah 2 gambar untuk melanjutkan.',
                    position: 'topRight'
                });
                return;
            }

            previewImg1.src = cropper1.getCroppedCanvas().toDataURL();
            previewImg1.classList.remove('hidden');
            
            previewImg2.src = cropper2.getCroppedCanvas().toDataURL();
            previewImg2.classList.remove('hidden');

            loaderSection.classList.add('hidden');
            previewSection.classList.remove('hidden');
            modal.classList.remove('hidden');
        };
        
        // Function to generate the PDF
        const generatePdf = async () => {
            previewSection.classList.add('hidden');
            loaderSection.classList.remove('hidden');

            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            const namaKegiatan = namaKegiatanInput.value;

            // Main Title
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text('DOKUMENTASI KEGIATAN', 105, 15, { align: 'center' });
            
            // Sub Title (Nama Kegiatan)
            doc.setFontSize(14);
            doc.setFont('helvetica', 'normal');
            doc.text(namaKegiatan, 105, 23, { align: 'center' });
            
            // User and Wilayah Info
            doc.setFontSize(10);
            const userInfo = `Desa ${userData.desa}, Kec. ${userData.kecamatan}, Kab. ${userData.kabupaten}`;
            doc.text(userInfo, 105, 30, { align: 'center' });


            const imgWidth = 150; // 15 cm
            const imgHeight = 100; // 10 cm
            const x = (210 - imgWidth) / 2;
            let y = 40;

            // Add first image
            const canvas1 = cropper1.getCroppedCanvas({ width: 1200, height: 900 });
            doc.addImage(canvas1.toDataURL('image/jpeg', 0.9), 'JPEG', x, y, imgWidth, imgHeight);
            y += imgHeight + 10;

            // Add second image
            const canvas2 = cropper2.getCroppedCanvas({ width: 1200, height: 900 });
            doc.addImage(canvas2.toDataURL('image/jpeg', 0.9), 'JPEG', x, y, imgWidth, imgHeight);
            
            // Get PDF data as a Data URI
            const pdfDataUri = doc.output('datauristring');

            setTimeout(() => {
                const fileName = `Dokumentasi - ${namaKegiatan.replace(/ /g, '_')}.pdf`;
                doc.save(fileName);
                modal.classList.add('hidden');

                iziToast.success({
                    title: 'Berhasil',
                    message: `PDF "${fileName}" telah dibuat.`,
                    position: 'topRight'
                });

                // Save to history with PDF data
                let history = JSON.parse(localStorage.getItem('pdfHistory')) || [];
                history.unshift({
                    namaKegiatan: namaKegiatan,
                    tanggal: new Date().toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' }),
                    pdfData: pdfDataUri,
                    fileName: fileName
                });
                localStorage.setItem('pdfHistory', JSON.stringify(history));

            }, 500);
        };

        const displayHistoryPage = () => {
            const history = JSON.parse(localStorage.getItem('pdfHistory')) || [];
            const totalItems = historyPage * ITEMS_PER_PAGE;
            const itemsToDisplay = history.slice(0, totalItems);
            
            historyTableBody.innerHTML = ''; // Clear previous entries

            if (itemsToDisplay.length === 0) {
                historyTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4">Belum ada riwayat.</td></tr>`;
                loadMoreBtn.classList.add('hidden');
                return;
            }

            itemsToDisplay.forEach((item, index) => {
                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="p-4">
                            <input type="checkbox" class="history-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded" data-index="${index}">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.namaKegiatan}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.tanggal}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 space-x-2">
                            <button class="download-btn text-blue-600 hover:text-blue-800" data-index="${index}">Unduh</button>
                            <button class="delete-btn text-red-600 hover:text-red-800" data-index="${index}">Hapus</button>
                        </td>
                    </tr>
                `;
                historyTableBody.innerHTML += row;
            });

            if (history.length > totalItems) {
                loadMoreBtn.classList.remove('hidden');
            } else {
                loadMoreBtn.classList.add('hidden');
            }
            updateDeleteSelectedButtonState();
        };

        const updateDeleteSelectedButtonState = () => {
            const checkedBoxes = document.querySelectorAll('.history-checkbox:checked');
            if (checkedBoxes.length > 0) {
                deleteSelectedBtn.classList.remove('hidden');
            } else {
                deleteSelectedBtn.classList.add('hidden');
            }
        };

        // Event Listeners
        namaKegiatanInput.addEventListener('input', validateNamaKegiatan);
        previewBtn.addEventListener('click', showPreview);
        confirmPdfBtn.addEventListener('click', generatePdf);
        cancelPdfBtn.addEventListener('click', () => modal.classList.add('hidden'));
        
        namaLengkapInput.addEventListener('input', validateNamaLengkap);
        desaSelect.addEventListener('change', validateDesa);

        simpanWilayahBtn.addEventListener('click', () => {
            simpanBtnText.classList.add('hidden');
            simpanBtnLoader.classList.remove('hidden');
            simpanWilayahBtn.disabled = true;

            const isNamaValid = validateNamaLengkap();
            const isDesaValid = validateDesa();
            
            setTimeout(() => {
                if (!isNamaValid || !isDesaValid) {
                    if (!isNamaValid) iziToast.error({ title: 'Gagal', message: 'Nama lengkap tidak boleh kosong.', position: 'topRight' });
                    if (!isDesaValid) iziToast.error({ title: 'Gagal', message: 'Silakan pilih desa/kelurahan.', position: 'topRight' });
                    
                    simpanBtnText.classList.remove('hidden');
                    simpanBtnLoader.classList.add('hidden');
                    simpanWilayahBtn.disabled = false;
                    return;
                }
                
                const currentUserData = {
                    namaLengkap: namaLengkapInput.value.trim(),
                    provinsi: provinsiSelect.value,
                    kabupaten: kabupatenSelect.value,
                    kecamatan: kecamatanSelect.value,
                    desa: desaSelect.value
                };

                localStorage.setItem('userData', JSON.stringify(currentUserData));
                handleLoginState(currentUserData);
            }, 500);
        });

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('userData');
            localStorage.removeItem('pdfHistory');
            iziToast.info({
                title: 'Logout',
                message: 'Anda telah berhasil logout.',
                position: 'topRight'
            });
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        });

        historyBtn.addEventListener('click', () => {
            historyPage = 1;
            displayHistoryPage();
            historyModal.classList.remove('hidden');
        });

        closeHistoryBtn.addEventListener('click', () => {
            historyModal.classList.add('hidden');
        });

        loadMoreBtn.addEventListener('click', () => {
            loadMoreText.classList.add('hidden');
            loadMoreLoader.classList.remove('hidden');
            loadMoreBtn.disabled = true;

            setTimeout(() => {
                historyPage++;
                displayHistoryPage();
                loadMoreText.classList.remove('hidden');
                loadMoreLoader.classList.add('hidden');
                loadMoreBtn.disabled = false;
            }, 500);
        });

        historyTableBody.addEventListener('click', (e) => {
            const history = JSON.parse(localStorage.getItem('pdfHistory')) || [];
            const index = e.target.dataset.index;

            if (e.target.classList.contains('download-btn')) {
                const item = history[index];
                if (item && item.pdfData) {
                    const link = document.createElement('a');
                    link.href = item.pdfData;
                    link.download = item.fileName || 'Dokumentasi.pdf';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    iziToast.success({ title: 'Berhasil', message: `Mengunduh ulang ${link.download}.`, position: 'topRight' });
                } else {
                    iziToast.error({ title: 'Gagal', message: 'Data PDF tidak ditemukan.', position: 'topRight' });
                }
            } else if (e.target.classList.contains('delete-btn')) {
                iziToast.question({
                    timeout: 20000,
                    close: false,
                    overlay: true,
                    displayMode: 'once',
                    id: 'question',
                    zindex: 9999,
                    title: 'Konfirmasi',
                    message: 'Apakah Anda yakin ingin menghapus riwayat ini?',
                    position: 'center',
                    buttons: [
                        ['<button><b>YA</b></button>', function (instance, toast) {
                            instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');
                            history.splice(index, 1);
                            localStorage.setItem('pdfHistory', JSON.stringify(history));
                            displayHistoryPage();
                            iziToast.success({ title: 'Berhasil', message: 'Riwayat telah dihapus.', position: 'topRight' });
                        }, true],
                        ['<button>TIDAK</button>', function (instance, toast) {
                            instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');
                        }],
                    ],
                });
            } else if (e.target.classList.contains('history-checkbox')) {
                updateDeleteSelectedButtonState();
            }
        });

        selectAllCheckbox.addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('.history-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = e.target.checked);
            updateDeleteSelectedButtonState();
        });

        deleteSelectedBtn.addEventListener('click', () => {
            const checkedBoxes = document.querySelectorAll('.history-checkbox:checked');
            const indicesToDelete = Array.from(checkedBoxes).map(cb => parseInt(cb.dataset.index));

            iziToast.question({
                timeout: 20000,
                close: false,
                overlay: true,
                displayMode: 'once',
                id: 'question',
                zindex: 9999,
                title: 'Konfirmasi',
                message: `Apakah Anda yakin ingin menghapus ${indicesToDelete.length} riwayat terpilih?`,
                position: 'center',
                buttons: [
                    ['<button><b>YA</b></button>', function (instance, toast) {
                        instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');
                        let history = JSON.parse(localStorage.getItem('pdfHistory')) || [];
                        const newHistory = history.filter((_, index) => !indicesToDelete.includes(index));
                        localStorage.setItem('pdfHistory', JSON.stringify(newHistory));
                        displayHistoryPage();
                        iziToast.success({ title: 'Berhasil', message: 'Riwayat terpilih telah dihapus.', position: 'topRight' });
                    }, true],
                    ['<button>TIDAK</button>', function (instance, toast) {
                        instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');
                    }],
                ],
            });
        });

    </script>
</body>
</html>
