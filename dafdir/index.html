<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDIP | Aplikasi Absensi</title>
    <link rel="manifest" href="manifest.json">
    <!-- Shortcut Icon -->
    <link rel="shortcut icon" href="https://newsiga-siga.bkkbn.go.id/icon_bkkbn.png">
    <!-- Menggunakan Tailwind CSS untuk styling yang modern dan responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Import library face-api.js -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <!-- Import iziToast untuk notifikasi -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/css/iziToast.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/js/iziToast.min.js"></script>
    <!-- Import SheetJS (XLSX) untuk membuat file Excel/CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Import jsPDF dan jsPDF-AutoTable untuk membuat file PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Custom styles untuk overlay video dan canvas */
        .video-container {
            position: relative;
            width: 100%;
            max-width: 720px;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        #video, #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #video {
            object-fit: cover;
        }
        .loader {
            border: 8px solid #f3f3f3;
            border-radius: 50%;
            border-top: 8px solid #3498db;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }
        .loader-sm {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #4f46e5;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Aplikasi Absensi Wajah</h1>
        </header>

        <!-- Loading Indicator -->
        <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex flex-col items-center justify-center z-50">
            <div class="loader"></div>
            <p id="loading-text" class="text-white mt-4 text-lg">Memuat model...</p>
        </div>

        <main class="grid grid-cols-1 gap-8">
            <!-- Kolom Absensi dan Daftar Hadir -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex justify-center mb-4 space-x-4">
                    <button id="startButton" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:bg-gray-400">
                        Mulai Absensi via Camera
                    </button>
                    <button id="switchCameraButton" class="hidden w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600">
                        Ganti Kamera
                    </button>
                </div>
                <div class="video-container bg-gray-900 aspect-[9/16] md:aspect-video mx-auto">
                    <video id="video" autoplay muted playsinline></video>
                    <canvas id="canvas"></canvas>
                </div>
                 <p id="detection-status" class="text-center text-sm text-gray-500 mt-2 h-4"></p>
                
                <!-- Daftar Hadir -->
                <div class="mt-8">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                        <h2 class="text-2xl font-semibold">Daftar Hadir Hari Ini</h2>
                        <div class="flex space-x-2">
                            <button id="recapButton" class="bg-gray-700 text-white py-2 px-4 rounded-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                Rekap Kehadiran
                            </button>
                            <button id="exportPdfButton" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                Rekap PDF
                            </button>
                             <button id="exportExcelButton" class="bg-emerald-600 text-white py-2 px-4 rounded-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500">
                                Rekap Excel
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                    <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hari</th>
                                    <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam</th>
                                    <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="attendance-list" class="divide-y divide-gray-200">
                                <!-- Daftar hadir akan muncul di sini dari localStorage -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Floating Action Button (FAB) -->
    <button id="fab" class="fixed bottom-6 right-6 bg-indigo-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
    </button>

    <!-- PIN Modal -->
    <div id="pinModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-40">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Masukkan PIN</h2>
            <input type="password" id="pinInput" class="w-full px-4 py-2 border border-gray-300 rounded-md text-center text-lg tracking-widest" placeholder="••••••">
            <button id="pinSubmit" class="w-full mt-6 bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700 flex items-center justify-center h-10 disabled:bg-indigo-400">
                <span id="pinSubmitText">Login</span>
                <div id="pinLoader" class="hidden loader-sm"></div>
            </button>
            <button id="pinCancel" class="w-full mt-2 bg-gray-200 text-gray-700 py-2 rounded-md hover:bg-gray-300 disabled:bg-gray-300">Batal</button>
        </div>
    </div>

    <!-- Registration Modal -->
    <div id="registrationModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">Registrasi & Manajemen Data</h2>
                <button id="closeRegistrationModal" class="text-gray-500 hover:text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div class="flex flex-col space-y-8">
                <div>
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">1. Registrasi Peserta</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                            <input type="text" id="name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Foto Wajah</label>
                            <div class="mt-1 flex items-center space-x-4">
                                <label for="imageUpload" class="w-full text-center bg-gray-100 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-200 cursor-pointer border border-gray-300">
                                    Unggah File
                                </label>
                                <button id="takePictureButton" class="w-full bg-indigo-100 text-indigo-700 py-2 px-4 rounded-md hover:bg-indigo-200 border border-indigo-200">
                                    Ambil Foto
                                </button>
                            </div>
                            <input type="file" id="imageUpload" class="hidden" accept="image/*">
                            <div id="imagePreviewContainer" class="mt-4 text-center hidden">
                                <img id="imagePreview" class="max-h-40 mx-auto rounded-md shadow-sm"/>
                                <p id="imageName" class="text-xs text-gray-500 mt-1"></p>
                            </div>
                        </div>
                        <button id="registerButton" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 flex items-center justify-center h-10 disabled:bg-indigo-400">
                            <span id="registerButtonText">Daftarkan Wajah</span>
                            <div id="registerLoader" class="hidden loader-sm"></div>
                        </button>
                        <p id="register-status" class="text-center text-sm text-gray-500 h-4"></p>
                    </div>
                </div>
                <!-- Bagian Daftar Peserta -->
                <div class="pt-6 border-t">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">3. Daftar Peserta</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                    <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Lengkap</th>
                                    <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="registeredListTableBody" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
                <!-- Bagian Backup dan Restore Data -->
                <div class="pt-6 border-t">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">2. Backup & Restore</h3>
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button id="exportButton" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Ekspor Data Peserta
                        </button>
                        <label for="importFile" class="w-full text-center bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 cursor-pointer">
                            Impor Data Peserta
                        </label>
                        <input type="file" id="importFile" class="hidden" accept=".json">
                        <button id="exportAttendanceButton" class="w-full bg-cyan-600 text-white py-2 px-4 rounded-md hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500">
                            Ekspor Kehadiran
                        </button>
                        <label for="importAttendanceFile" class="w-full text-center bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 cursor-pointer">
                            Impor Kehadiran
                        </label>
                        <input type="file" id="importAttendanceFile" class="hidden" accept=".json">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Camera Capture Modal -->
    <div id="cameraModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-4 rounded-lg shadow-xl w-full max-w-md mx-4">
            <video id="cameraPreview" class="w-full rounded-md" autoplay playsinline></video>
            <canvas id="captureCanvas" class="hidden"></canvas>
            <div class="flex space-x-4 mt-4">
                <button id="captureBtn" class="w-full bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700">Ambil Gambar</button>
                <button id="cancelCaptureBtn" class="w-full bg-gray-200 text-gray-700 py-2 rounded-md hover:bg-gray-300">Batal</button>
            </div>
        </div>
    </div>

    <!-- Recap Modal -->
    <div id="recapModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">Rekapitulasi Kehadiran</h2>
                <button id="closeRecapModal" class="text-gray-500 hover:text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="recapLoader" class="hidden flex justify-center items-center py-10">
                <div class="loader"></div>
            </div>
            <div id="recapContent">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Provinsi</label>
                        <input type="text" value="JAWA BARAT" class="mt-1 block w-full bg-gray-100 border-gray-300 rounded-md shadow-sm" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Kab/Kota</label>
                        <input type="text" value="SUKABUMI" class="mt-1 block w-full bg-gray-100 border-gray-300 rounded-md shadow-sm" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Kecamatan</label>
                        <input type="text" value="CIEMAS" class="mt-1 block w-full bg-gray-100 border-gray-300 rounded-md shadow-sm" readonly>
                    </div>
                    <div>
                        <label for="recapYear" class="block text-sm font-medium text-gray-700">Tahun</label>
                        <select id="recapYear" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            <option>2025</option>
                            <option>2024</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label for="recapMonth" class="block text-sm font-medium text-gray-700">Bulan</label>
                        <select id="recapMonth" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></select>
                    </div>
                </div>
                <button id="showRecapButton" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Tampilkan Rekap</button>
                <div id="recapResultContainer" class="mt-6 hidden">
                    <div id="recapProcessLoader" class="hidden flex justify-center items-center py-10">
                        <div class="loader"></div>
                    </div>
                    <div id="recapTableContent">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-xl font-semibold text-gray-800">Hasil Rekap</h3>
                            <button id="exportRecapPdfButton" class="hidden bg-purple-600 text-white py-1 px-3 rounded-md hover:bg-purple-700 text-sm">Export PDF Rekap</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                        <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Lengkap</th>
                                        <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hari Hadir (Tanggal)</th>
                                        <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah Kehadiran</th>
                                    </tr>
                                </thead>
                                <tbody id="recapResultTable" class="divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- DOM ELEMENT REFERENCES ---
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const startButton = document.getElementById('startButton');
        const registerButton = document.getElementById('registerButton');
        const imageUpload = document.getElementById('imageUpload');
        const nameInput = document.getElementById('name');
        const attendanceList = document.getElementById('attendance-list');
        const loadingDiv = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');
        const registerStatus = document.getElementById('register-status');
        const detectionStatus = document.getElementById('detection-status');
        const exportButton = document.getElementById('exportButton');
        const importFile = document.getElementById('importFile');
        const exportExcelButton = document.getElementById('exportExcelButton');
        const exportPdfButton = document.getElementById('exportPdfButton');
        const fab = document.getElementById('fab');
        const pinModal = document.getElementById('pinModal');
        const pinInput = document.getElementById('pinInput');
        const pinSubmit = document.getElementById('pinSubmit');
        const pinCancel = document.getElementById('pinCancel');
        const registrationModal = document.getElementById('registrationModal');
        const closeRegistrationModal = document.getElementById('closeRegistrationModal');
        const pinSubmitText = document.getElementById('pinSubmitText');
        const pinLoader = document.getElementById('pinLoader');
        const takePictureButton = document.getElementById('takePictureButton');
        const cameraModal = document.getElementById('cameraModal');
        const cameraPreview = document.getElementById('cameraPreview');
        const captureCanvas = document.getElementById('captureCanvas');
        const captureBtn = document.getElementById('captureBtn');
        const cancelCaptureBtn = document.getElementById('cancelCaptureBtn');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const imageName = document.getElementById('imageName');
        const recapButton = document.getElementById('recapButton');
        const recapModal = document.getElementById('recapModal');
        const closeRecapModal = document.getElementById('closeRecapModal');
        const recapLoader = document.getElementById('recapLoader');
        const recapContent = document.getElementById('recapContent');
        const recapMonth = document.getElementById('recapMonth');
        const recapYear = document.getElementById('recapYear');
        const showRecapButton = document.getElementById('showRecapButton');
        const recapResultContainer = document.getElementById('recapResultContainer');
        const recapResultTable = document.getElementById('recapResultTable');
        const recapProcessLoader = document.getElementById('recapProcessLoader');
        const recapTableContent = document.getElementById('recapTableContent');
        const registerButtonText = document.getElementById('registerButtonText');
        const registerLoader = document.getElementById('registerLoader');
        const registeredListTableBody = document.getElementById('registeredListTableBody');
        const exportRecapPdfButton = document.getElementById('exportRecapPdfButton');
        const exportAttendanceButton = document.getElementById('exportAttendanceButton');
        const importAttendanceFile = document.getElementById('importAttendanceFile');
        const switchCameraButton = document.getElementById('switchCameraButton');


        // --- STATE MANAGEMENT ---
        let registeredStudents = [];
        let faceMatcher = null;
        let recognitionInterval = null;
        let capturedImageBlob = null;
        const STUDENTS_STORAGE_KEY = 'faceAttendanceApp_students';
        let synthVoices = [];
        let currentRecapData = [];
        let videoDevices = [];
        let currentDeviceIndex = 0;

        // --- NOTIFICATION FUNCTION ---
        function showSuccessNotification(name) {
            iziToast.success({
                title: 'Berhasil',
                message: `${name}, absensi Anda telah dicatat.`,
                position: 'topRight',
                timeout: 5000,
            });
        }

        // --- AUDIO FUNCTION (Browser Speech Synthesis) ---
        function loadVoices() {
            synthVoices = window.speechSynthesis.getVoices();
        }
        
        if ('speechSynthesis' in window) {
            loadVoices();
            if (window.speechSynthesis.onvoiceschanged !== undefined) {
                window.speechSynthesis.onvoiceschanged = loadVoices;
            }
        }

        function playSuccessSound(name) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const textToSpeak = `${name}, Anda sudah berhasil absensi untuk hari ini.`;
                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                utterance.lang = 'id-ID';
                utterance.rate = 0.9;
                utterance.pitch = 1;
                let selectedVoice = synthVoices.find(voice => voice.lang === 'id-ID' && voice.name.includes('Female')) || synthVoices.find(voice => voice.lang === 'id-ID' && voice.name.includes('Google')) || synthVoices.find(voice => voice.lang === 'id-ID');
                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                } else {
                    console.warn("Tidak ditemukan suara berbahasa Indonesia. Menggunakan suara default.");
                }
                window.speechSynthesis.speak(utterance);
            } else {
                console.error("Speech Synthesis tidak didukung di browser ini.");
            }
        }

        // --- LOCALSTORAGE & DATE FUNCTIONS ---
        function getTodayDateString() {
            return new Date().toISOString().split('T')[0];
        }

        function saveDataToLocalStorage() {
            const savableData = registeredStudents.map(student => ({
                name: student.name,
                descriptor: Array.from(student.descriptor),
                attendanceRecords: student.attendanceRecords || []
            }));
            localStorage.setItem(STUDENTS_STORAGE_KEY, JSON.stringify(savableData));
        }

        function loadAndResetData() {
            const data = localStorage.getItem(STUDENTS_STORAGE_KEY);
            if (data) {
                const parsedData = JSON.parse(data);
                registeredStudents = parsedData.map(student => ({
                    name: student.name,
                    descriptor: new Float32Array(student.descriptor),
                    attendanceRecords: student.attendanceRecords || []
                }));
            }
        }
        
        function renderAttendanceList() {
            const today = getTodayDateString();
            attendanceList.innerHTML = '';
            registeredStudents.forEach(student => {
                const row = document.createElement('tr');
                row.setAttribute('data-name', student.name);

                const todaysRecord = student.attendanceRecords.find(rec => rec.date === today);
                
                let statusBadge = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Belum Hadir</span>`;
                let hari = '-';
                let tanggal = '-';
                let jam = '-';
                let actionButton = '<td></td>'; // Empty cell if not attended

                if (todaysRecord) {
                    statusBadge = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Hadir</span>`;
                    row.classList.add('bg-green-50');
                    // Safely create date object
                    const recordDate = new Date(`${todaysRecord.date}T${todaysRecord.time}`);
                    if (!isNaN(recordDate)) {
                        hari = recordDate.toLocaleDateString('id-ID', { weekday: 'long' });
                        tanggal = recordDate.toLocaleDateString('id-ID');
                        jam = recordDate.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                    }
                    actionButton = `
                        <td class="py-4 px-6 text-center">
                            <button class="reset-attendance-btn text-xs bg-yellow-500 hover:bg-yellow-600 text-white py-1 px-2 rounded" data-name="${student.name}">
                                Ulangi
                            </button>
                        </td>
                    `;
                }

                row.innerHTML = `
                    <td class="py-4 px-6 text-sm font-medium text-gray-900">${student.name}</td>
                    <td class="py-4 px-6 text-sm text-gray-500">${statusBadge}</td>
                    <td class="py-4 px-6 text-sm text-gray-700">${hari}</td>
                    <td class="py-4 px-6 text-sm text-gray-700">${tanggal}</td>
                    <td class="py-4 px-6 text-sm text-gray-700">${jam}</td>
                    ${actionButton}
                `;
                attendanceList.appendChild(row);
            });
        }

        function renderRegisteredListTable() {
            registeredListTableBody.innerHTML = '';
            if (registeredStudents.length === 0) {
                registeredListTableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-gray-500">Belum ada peserta terdaftar.</td></tr>`;
                return;
            }
            registeredStudents.forEach((student, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-2 px-4 border-b">${index + 1}</td>
                    <td class="py-2 px-4 border-b">${student.name}</td>
                    <td class="py-2 px-4 border-b space-x-2">
                        <button class="edit-btn text-xs bg-blue-500 hover:bg-blue-600 text-white py-1 px-2 rounded" data-name="${student.name}">Edit</button>
                        <button class="delete-btn text-xs bg-red-500 hover:bg-red-600 text-white py-1 px-2 rounded" data-name="${student.name}">Hapus</button>
                    </td>
                `;
                registeredListTableBody.appendChild(row);
            });
        }

        // --- INITIALIZATION ---
        async function initializeApp() {
            await loadModels();
            await getVideoDevices();
            loadAndResetData();
            renderAttendanceList();
            await updateFaceMatcher();
        }

        async function loadModels() {
            const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL)
                ]);
                loadingText.innerText = 'Aplikasi siap digunakan.';
                setTimeout(() => {
                    loadingDiv.style.display = 'none';
                }, 1500);
            } catch (error) {
                console.error("Gagal memuat model:", error);
                loadingText.innerText = 'Gagal memuat model. Coba segarkan halaman.';
            }
        }
        
        initializeApp();

        // --- CORE FUNCTIONS ---
        async function getLabeledFaceDescriptions() {
            return registeredStudents.map(student => 
                new faceapi.LabeledFaceDescriptors(student.name, [student.descriptor])
            );
        }

        async function updateFaceMatcher() {
            const labeledDescriptors = await getLabeledFaceDescriptions();
            if (labeledDescriptors.length > 0) {
                faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.5); // Stricter threshold
            } else {
                faceMatcher = null;
            }
        }
        
        async function getVideoDevices() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                videoDevices = devices.filter(device => device.kind === 'videoinput');
            } catch (err) {
                console.error("Tidak bisa mendapatkan daftar perangkat kamera:", err);
            }
        }

        // --- EVENT LISTENERS ---
        registerButton.addEventListener('click', async () => {
            const name = nameInput.value.trim();
            const imageFile = imageUpload.files[0];
            const imageSource = capturedImageBlob || imageFile;

            if (!name || !imageSource) {
                iziToast.warning({ title: 'Input Tidak Lengkap', message: 'Nama dan foto wajah harus diisi.' });
                return;
            }
            
            registerButtonText.classList.add('hidden');
            registerLoader.classList.remove('hidden');
            registerButton.disabled = true;

            try {
                const image = await faceapi.bufferToImage(imageSource);
                const detection = await faceapi.detectSingleFace(image, new faceapi.SsdMobilenetv1Options()).withFaceLandmarks().withFaceDescriptor();
                if (!detection) {
                    iziToast.error({ title: 'Gagal', message: 'Wajah tidak terdeteksi di gambar.' });
                    return;
                }
                if(registeredStudents.find(s => s.name.toLowerCase() === name.toLowerCase())){
                    iziToast.warning({ title: 'Duplikat', message: `Nama "${name}" sudah terdaftar.` });
                    return;
                }
                registeredStudents.push({ name: name, descriptor: detection.descriptor, attendanceRecords: [] });
                saveDataToLocalStorage();
                renderAttendanceList();
                renderRegisteredListTable();
                await updateFaceMatcher();
                iziToast.success({ title: 'Berhasil', message: `"${name}" berhasil didaftarkan!` });
                // Reset form
                nameInput.value = '';
                imageUpload.value = '';
                capturedImageBlob = null;
                imagePreviewContainer.classList.add('hidden');

            } catch (error) {
                console.error("Error saat registrasi:", error);
                iziToast.error({ title: 'Error', message: 'Terjadi kesalahan saat memproses gambar.' });
            } finally {
                registerButtonText.classList.remove('hidden');
                registerLoader.classList.add('hidden');
                registerButton.disabled = false;
            }
        });

        startButton.addEventListener('click', async () => {
            if (registeredStudents.length === 0) {
                iziToast.info({ title: 'Info', message: 'Daftarkan atau impor data wajah terlebih dahulu.' });
                return;
            }
            if (recognitionInterval) {
                stopAttendanceStream();
                return;
            }
            startButton.innerText = "Mengakses Camera...";
            startButton.disabled = true;
            try {
                const constraints = {
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                };
                if (videoDevices.length > 0) {
                    constraints.video.deviceId = { exact: videoDevices[currentDeviceIndex].deviceId };
                }
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                startButton.innerText = "Hentikan Absensi";
                startButton.classList.replace('bg-green-600', 'bg-red-600');
                startButton.classList.replace('hover:bg-green-700', 'hover:bg-red-700');
                if (videoDevices.length > 1) {
                    switchCameraButton.classList.remove('hidden');
                }
            } catch (err) {
                console.error("Error mengakses webcam: ", err);
                iziToast.error({ title: 'Error', message: 'Gagal mengakses webcam. Pastikan Anda memberikan izin.' });
                startButton.innerText = "Mulai Absensi via Camera";
            } finally {
                startButton.disabled = false;
            }
        });

        video.addEventListener('play', () => {
            const displaySize = { width: video.clientWidth, height: video.clientHeight };
            faceapi.matchDimensions(canvas, displaySize);
            // OPTIMISASI: Kurangi frekuensi deteksi untuk meringankan beban di mobile
            recognitionInterval = setInterval(async () => {
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptors();
                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if (faceMatcher && resizedDetections.length > 0) {
                    detectionStatus.innerText = `${resizedDetections.length} wajah terdeteksi.`;
                    const results = resizedDetections.map(d => faceMatcher.findBestMatch(d.descriptor));
                    results.forEach((result, i) => {
                        const box = resizedDetections[i].detection.box;
                        new faceapi.draw.DrawBox(box, { label: result.toString() }).draw(canvas);
                        if (result.label !== 'unknown') {
                            const student = registeredStudents.find(s => s.name === result.label);
                            const today = getTodayDateString();
                            const alreadyAttended = student && student.attendanceRecords.some(rec => rec.date === today);
                            
                            if (student && !alreadyAttended) {
                                const now = new Date();
                                student.attendanceRecords.push({
                                    date: today,
                                    time: now.toLocaleTimeString('en-GB') // Use en-GB for HH:mm:ss format
                                });
                                showSuccessNotification(student.name);
                                playSuccessSound(student.name);
                                saveDataToLocalStorage();
                                renderAttendanceList();
                            }
                        }
                    });
                } else {
                    detectionStatus.innerText = 'Arahkan wajah ke kamera...';
                }
            }, 700); // Interval diperpanjang menjadi 700ms
        });

        // --- MODAL & CAMERA LISTENERS ---
        function stopAttendanceStream() {
            if (recognitionInterval) {
                clearInterval(recognitionInterval);
                recognitionInterval = null;
                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                }
                startButton.innerText = "Mulai Absensi via Camera";
                startButton.classList.replace('bg-red-600', 'bg-green-600');
                startButton.classList.replace('hover:bg-red-700', 'hover:bg-green-700');
                switchCameraButton.classList.add('hidden');
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        switchCameraButton.addEventListener('click', () => {
            currentDeviceIndex = (currentDeviceIndex + 1) % videoDevices.length;
            stopAttendanceStream();
            setTimeout(() => startButton.click(), 100); // Delay to ensure stream is stopped
        });

        fab.addEventListener('click', () => {
            stopAttendanceStream(); // Hentikan absensi saat FAB diklik
            pinModal.classList.remove('hidden');
            pinInput.focus();
        });

        pinCancel.addEventListener('click', () => {
            pinModal.classList.add('hidden');
            pinInput.value = '';
        });

        pinSubmit.addEventListener('click', () => {
            pinSubmitText.classList.add('hidden');
            pinLoader.classList.remove('hidden');
            pinSubmit.disabled = true;
            pinCancel.disabled = true;

            setTimeout(() => {
                if (pinInput.value === 'ciemas25') {
                    pinModal.classList.add('hidden');
                    registrationModal.classList.remove('hidden');
                    renderRegisteredListTable();
                    pinInput.value = '';
                } else {
                    iziToast.error({ title: 'Gagal', message: 'PIN yang Anda masukkan salah.' });
                    pinInput.value = '';
                }

                pinSubmitText.classList.remove('hidden');
                pinLoader.classList.add('hidden');
                pinSubmit.disabled = false;
                pinCancel.disabled = false;
            }, 500);
        });
        
        pinInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                pinSubmit.click();
            }
        });

        closeRegistrationModal.addEventListener('click', () => {
            registrationModal.classList.add('hidden');
        });

        takePictureButton.addEventListener('click', async () => {
            cameraModal.classList.remove('hidden');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                cameraPreview.srcObject = stream;
            } catch (err) {
                console.error("Error accessing camera for capture:", err);
                iziToast.error({ title: 'Error', message: 'Gagal mengakses kamera.' });
                cameraModal.classList.add('hidden');
            }
        });

        function stopCaptureStream() {
            if (cameraPreview.srcObject) {
                cameraPreview.srcObject.getTracks().forEach(track => track.stop());
            }
        }

        cancelCaptureBtn.addEventListener('click', () => {
            stopCaptureStream();
            cameraModal.classList.add('hidden');
        });

        captureBtn.addEventListener('click', () => {
            const context = captureCanvas.getContext('2d');
            captureCanvas.width = cameraPreview.videoWidth;
            captureCanvas.height = cameraPreview.videoHeight;
            context.drawImage(cameraPreview, 0, 0, captureCanvas.width, captureCanvas.height);
            
            captureCanvas.toBlob(blob => {
                capturedImageBlob = blob;
                imagePreview.src = URL.createObjectURL(blob);
                imageName.textContent = 'Gambar dari kamera.png';
                imagePreviewContainer.classList.remove('hidden');
                imageUpload.value = ''; // Clear file input
            }, 'image/png');

            stopCaptureStream();
            cameraModal.classList.add('hidden');
        });

        imageUpload.addEventListener('change', () => {
            const file = imageUpload.files[0];
            if (file) {
                capturedImageBlob = null; // Clear captured blob
                imagePreview.src = URL.createObjectURL(file);
                imageName.textContent = file.name;
                imagePreviewContainer.classList.remove('hidden');
            }
        });

        // --- EXPORT/IMPORT LISTENERS ---
        exportButton.addEventListener('click', () => {
            if (registeredStudents.length === 0) {
                iziToast.info({ title: 'Info', message: 'Tidak ada data peserta untuk diekspor.' });
                return;
            }
            const dataToExport = registeredStudents.map(s => ({name: s.name, descriptor: Array.from(s.descriptor)}));
            const dataStr = JSON.stringify(dataToExport);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `data_peserta_absensi_${getTodayDateString()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            iziToast.success({ title: 'Berhasil', message: 'Data peserta telah diekspor.' });
        });

        importFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!Array.isArray(data) || data.some(item => !item.name || !item.descriptor)) {
                        throw new Error('Format file tidak valid.');
                    }
                    if (confirm('Ini akan menimpa semua data peserta yang ada. Lanjutkan?')) {
                        // Saat impor, pastikan struktur data baru diterapkan
                        const importedData = data.map(p => ({...p, attendanceRecords: p.attendanceRecords || []}));
                        localStorage.setItem(STUDENTS_STORAGE_KEY, JSON.stringify(importedData));
                        loadAndResetData();
                        renderAttendanceList();
                        renderRegisteredListTable();
                        await updateFaceMatcher();
                        iziToast.success({ title: 'Berhasil', message: `${data.length} data peserta berhasil diimpor.` });
                    }
                } catch (error) {
                    console.error("Gagal mengimpor data:", error);
                    iziToast.error({ title: 'Gagal', message: `File tidak dapat diimpor. Pastikan formatnya benar. (${error.message})` });
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        });

        exportAttendanceButton.addEventListener('click', () => {
            if (registeredStudents.length === 0) {
                iziToast.info({ title: 'Info', message: 'Tidak ada data kehadiran untuk diekspor.' });
                return;
            }
            const dataToExport = registeredStudents.map(s => ({name: s.name, attendanceRecords: s.attendanceRecords}));
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `data_kehadiran_${getTodayDateString()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            iziToast.success({ title: 'Berhasil', message: 'Data kehadiran telah diekspor.' });
        });

        importAttendanceFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedAttendance = JSON.parse(e.target.result);
                    if (!Array.isArray(importedAttendance) || importedAttendance.some(item => !item.name || !item.attendanceRecords)) {
                        throw new Error('Format file tidak valid.');
                    }
                    if (confirm('Ini akan menggabungkan data kehadiran yang ada. Lanjutkan?')) {
                        importedAttendance.forEach(importedStudent => {
                            const existingStudent = registeredStudents.find(s => s.name === importedStudent.name);
                            if (existingStudent) {
                                const existingDates = new Set(existingStudent.attendanceRecords.map(rec => rec.date));
                                importedStudent.attendanceRecords.forEach(newRecord => {
                                    if (!existingDates.has(newRecord.date)) {
                                        existingStudent.attendanceRecords.push(newRecord);
                                    }
                                });
                            }
                        });
                        saveDataToLocalStorage();
                        renderAttendanceList();
                        iziToast.success({ title: 'Berhasil', message: `Data kehadiran berhasil digabungkan.` });
                    }
                } catch (error) {
                    console.error("Gagal mengimpor data kehadiran:", error);
                    iziToast.error({ title: 'Gagal', message: `File tidak dapat diimpor. Pastikan formatnya benar. (${error.message})` });
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        });

        // --- REKAP LISTENERS ---
        function getWorkdaysInMonth(month, year) {
            const date = new Date(year, month, 1);
            let workdays = 0;
            while (date.getMonth() === month) {
                const day = date.getDay();
                if (day !== 0 && day !== 6) { // 0 = Sunday, 6 = Saturday
                    workdays++;
                }
                date.setDate(date.getDate() + 1);
            }
            return workdays;
        }

        recapButton.addEventListener('click', () => {
            recapModal.classList.remove('hidden');
            recapContent.classList.add('hidden');
            recapLoader.classList.remove('hidden');

            const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            recapMonth.innerHTML = months.map((month, index) => `<option value="${index}">${month}</option>`).join('');
            
            const now = new Date();
            recapMonth.value = now.getMonth();
            recapYear.value = now.getFullYear();

            setTimeout(() => {
                recapLoader.classList.add('hidden');
                recapContent.classList.remove('hidden');
                recapResultContainer.classList.add('hidden');
            }, 500);
        });

        closeRecapModal.addEventListener('click', () => {
            recapModal.classList.add('hidden');
        });

        showRecapButton.addEventListener('click', () => {
            recapResultContainer.classList.remove('hidden');
            recapTableContent.classList.add('hidden');
            recapProcessLoader.classList.remove('hidden');
            exportRecapPdfButton.classList.add('hidden');
            
            setTimeout(() => {
                const selectedMonth = parseInt(recapMonth.value);
                const selectedYear = parseInt(recapYear.value);
                const workdaysInMonth = getWorkdaysInMonth(selectedMonth, selectedYear);

                recapResultTable.innerHTML = '';
                currentRecapData = []; // Clear previous recap data
                
                const recapData = registeredStudents.map((student, index) => {
                    const attendedRecords = student.attendanceRecords.filter(record => {
                        const recordDate = new Date(record.date);
                        return recordDate.getMonth() === selectedMonth && recordDate.getFullYear() === selectedYear;
                    });
                    const attendedDates = attendedRecords.map(rec => new Date(rec.date).getDate()).join(', ');
                    
                    const data = { 
                        no: index + 1,
                        name: student.name, 
                        attendedDates: attendedDates || '-',
                        attendanceSummary: `${attendedRecords.length} / ${workdaysInMonth} hari`
                    };
                    currentRecapData.push(data);
                    return data;
                });

                if (recapData.length === 0) {
                    recapResultTable.innerHTML = `<tr><td colspan="4" class="text-center py-4">Tidak ada data peserta.</td></tr>`;
                } else {
                    recapData.forEach((data) => {
                        const row = `
                            <tr>
                                <td class="py-2 px-4 border-b">${data.no}</td>
                                <td class="py-2 px-4 border-b">${data.name}</td>
                                <td class="py-2 px-4 border-b">${data.attendedDates}</td>
                                <td class="py-2 px-4 border-b">${data.attendanceSummary}</td>
                            </tr>
                        `;
                        recapResultTable.innerHTML += row;
                    });
                    exportRecapPdfButton.classList.remove('hidden');
                }
                recapProcessLoader.classList.add('hidden');
                recapTableContent.classList.remove('hidden');
            }, 500);
        });

        // --- REKAP EXCEL LISTENER ---
        exportExcelButton.addEventListener('click', () => {
            if (registeredStudents.length === 0) {
                iziToast.info({ title: 'Info', message: 'Tidak ada data absensi untuk direkap.' });
                return;
            }
            const dataForSheet = registeredStudents.map(student => {
                const todaysRecord = student.attendanceRecords.find(rec => rec.date === getTodayDateString());
                const recordDate = todaysRecord ? new Date(`${todaysRecord.date}T${todaysRecord.time}`) : null;
                return {
                    Nama: student.name,
                    Status: todaysRecord ? 'Hadir' : 'Belum Hadir',
                    Hari: recordDate && !isNaN(recordDate) ? recordDate.toLocaleDateString('id-ID', { weekday: 'long' }) : '-',
                    Tanggal: recordDate && !isNaN(recordDate) ? recordDate.toLocaleDateString('id-ID') : '-',
                    Jam: recordDate && !isNaN(recordDate) ? recordDate.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '-'
                };
            });
            const worksheet = XLSX.utils.json_to_sheet(dataForSheet);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Rekap Absensi Harian');
            XLSX.writeFile(workbook, `Rekap_Harian_${getTodayDateString()}.xlsx`);
            iziToast.success({ title: 'Berhasil', message: 'File rekap harian berhasil dibuat.' });
        });
        
        // --- REKAP PDF LISTENERS ---
        exportPdfButton.addEventListener('click', () => {
            if (registeredStudents.length === 0) {
                iziToast.info({ title: 'Info', message: 'Tidak ada data absensi untuk direkap.' });
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const tableColumn = ["Nama", "Status", "Hari", "Tanggal", "Jam"];
            const tableRows = [];

            registeredStudents.forEach(student => {
                const todaysRecord = student.attendanceRecords.find(rec => rec.date === getTodayDateString());
                const recordDate = todaysRecord ? new Date(`${todaysRecord.date}T${todaysRecord.time}`) : null;
                const studentData = [
                    student.name,
                    todaysRecord ? 'Hadir' : 'Belum Hadir',
                    recordDate && !isNaN(recordDate) ? recordDate.toLocaleDateString('id-ID', { weekday: 'long' }) : '-',
                    recordDate && !isNaN(recordDate) ? recordDate.toLocaleDateString('id-ID') : '-',
                    recordDate && !isNaN(recordDate) ? recordDate.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '-'
                ];
                tableRows.push(studentData);
            });

            doc.setFontSize(18);
            doc.text("Rekapitulasi Daftar Hadir Harian", 14, 22);
            
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 30,
            });
            
            doc.save(`Rekap_Harian_${getTodayDateString()}.pdf`);
            iziToast.success({ title: 'Berhasil', message: 'File PDF rekap harian berhasil dibuat.' });
        });
        
        exportRecapPdfButton.addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            
            const selectedMonthText = recapMonth.options[recapMonth.selectedIndex].text;
            const selectedYear = recapYear.value;
            
            const tableColumn = ["No", "Nama Lengkap", "Hari Hadir (Tanggal)", "Jumlah Kehadiran"];
            const tableRows = currentRecapData.map(data => [data.no, data.name, data.attendedDates, data.attendanceSummary]);

            doc.setFontSize(16);
            doc.text("REKAPITULASI KEHADIRAN", doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
            
            doc.setFontSize(10);
            doc.text(`PROVINSI: JAWA BARAT`, 14, 30);
            doc.text(`KAB/KOTA: SUKABUMI`, 14, 35);
            doc.text(`KECAMATAN: CIEMAS`, 14, 40);
            doc.text(`BULAN: ${selectedMonthText.toUpperCase()}`, 14, 45);
            doc.text(`TAHUN: ${selectedYear}`, 14, 50);
            
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 55,
            });
            
            doc.save(`Rekap_Bulanan_${selectedMonthText}_${selectedYear}.pdf`);
            iziToast.success({ title: 'Berhasil', message: 'File PDF rekap bulanan berhasil dibuat.' });
        });

        // --- RESET ATTENDANCE LISTENER ---
        attendanceList.addEventListener('click', (event) => {
            if (event.target.classList.contains('reset-attendance-btn')) {
                const studentName = event.target.getAttribute('data-name');
                const student = registeredStudents.find(s => s.name === studentName);
                const today = getTodayDateString();

                if (student) {
                    student.attendanceRecords = student.attendanceRecords.filter(rec => rec.date !== today);
                    saveDataToLocalStorage();
                    renderAttendanceList();
                    iziToast.info({ title: 'Info', message: `Kehadiran untuk ${studentName} hari ini telah direset.` });
                }
            }
        });

        // --- REGISTERED LIST TABLE LISTENERS ---
        registeredListTableBody.addEventListener('click', async (event) => {
            const target = event.target;
            
            // Handle Delete
            if (target.classList.contains('delete-btn')) {
                const nameToDelete = target.dataset.name;
                if (confirm(`Apakah Anda yakin ingin menghapus ${nameToDelete}? Data kehadiran juga akan terhapus.`)) {
                    registeredStudents = registeredStudents.filter(s => s.name !== nameToDelete);
                    saveDataToLocalStorage();
                    renderRegisteredListTable();
                    renderAttendanceList();
                    await updateFaceMatcher();
                    iziToast.success({ title: 'Berhasil', message: `${nameToDelete} telah dihapus.` });
                }
            }

            // Handle Edit
            if (target.classList.contains('edit-btn')) {
                const oldName = target.dataset.name;
                const newName = prompt("Masukkan nama baru:", oldName);

                if (newName && newName.trim() !== '' && newName.trim() !== oldName) {
                    // Check for duplicates
                    if (registeredStudents.some(s => s.name.toLowerCase() === newName.trim().toLowerCase())) {
                        iziToast.error({ title: 'Gagal', message: 'Nama tersebut sudah ada.' });
                        return;
                    }
                    
                    const student = registeredStudents.find(s => s.name === oldName);
                    if (student) {
                        student.name = newName.trim();
                        saveDataToLocalStorage();
                        renderRegisteredListTable();
                        renderAttendanceList();
                        await updateFaceMatcher();
                        iziToast.success({ title: 'Berhasil', message: `Nama telah diubah menjadi ${newName.trim()}.` });
                    }
                }
            }
        });
    </script>
</body>
</html>

